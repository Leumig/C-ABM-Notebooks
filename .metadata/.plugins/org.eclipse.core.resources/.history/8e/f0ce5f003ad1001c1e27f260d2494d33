/*
 * Trabajo.c
 *
 *  Created on: 11 may. 2022
 *      Author: JUNMI
 */

#include <stdio.h>
#include <stdlib.h>
#include <string.h>

#include "Trabajo.h"
#include "Servicio.h"
#include "Notebook.h"
#include "Marca.h"
#include "Tipo.h"
#include "Menu.h"
#include "Validaciones.h"


int mostrarTrabajo(eTrabajo lista, eNotebook notebooks[], int tamNot, eServicio servicios[], int tamSer)
{
    int todoOk = 0;
    char descNotebook[20];
    char descServicio[20];


    if(notebooks != NULL && tamNot > 0 && servicios != NULL && tamSer > 0)
    {

    cargarDescripcionNotebook(notebooks, tamNot, lista.idNotebook, descNotebook);
    cargarDescripcionServicio(servicios, tamSer, lista.idServicio, descServicio);
    //Le pasamos lista.idSector para que la función sepa cuál ID de sector tiene que buscar, si es correcta y la encuentra,
    //nos devuelve un char de descripción en el parámetro 'descSector'


    printf("  %4d  %10s  %10s  %10s     %02d/%02d/%d\n",
    		lista.id, lista.idNotebook, lista.idServicio, lista.fPactada.dia, lista.fPactada.mes, lista.fPactada.anio);

        todoOk = 1;
    }
    return todoOk;
}

int listarTrabajos(eTrabajo vec[], eNotebook notebooks[], int tamNot, eServicio servicios[], int tamSer)
{
    int todoOk = 0;
    int flag = 0;
    if(vec != NULL && notebooks != NULL && tamNot > 0 && servicios != NULL && tamSer > 0)
    {
        printf("          *** Listado de Trabajos ***\n\n");
        printf("   ID             Notebook       Servicio       Fecha Pactada    \n");
        printf("-----------------------------------------------------------------\n");
        for(int i=0; i < 10; i++) // Recorro
        {
        	if(!vec[i].isEmpty)
        	{
                mostrarTrabajo(vec[i], notebooks, tamNot, servicios, tamSer);
                flag++;
        	}
        }
        if(flag == 0) //Si no hay mínimo 1 empleado... printeo que no hay
        {
            printf("     No hay trabajos en el sistema");
        }
        printf("\n\n");

        todoOk = 1;
    }
    return todoOk;
}

int buscarTrabajoLibre(eTrabajo vec[], int tam, int* pIndex)
{
    int todoOk = 0;
    if(vec != NULL && tam > 0 && pIndex != NULL)
    {
        *pIndex = -1;  //Ya lo cargamos con -1 (que no encontramos ninguno)
        for(int i=0; i < tam; i++) //Recorremos
        {
            if(vec[i].isEmpty == 1) //Si el empleado esta libre...
            {
                *pIndex = i; //Cargo el pIndex con el indice que acabamos de encontrar libre
                break; //Paramos de buscar
            }
        }
        todoOk = 1;
    }
    return todoOk;
}



int altaTrabajo(eTrabajo vec[], int tam, int* pId, eNotebook notebooks[], int tamNot, eMarca marcas[], int tamMar,
		eTipo tipos[], int tamTip, eServicio servicios[], int tamSer)
{                      //Recibe las estructuras con sus tam y un puntero a Legajo (ID)
    int todoOk = 0;
    int indice;   // Este va a ser indice al que le vamos a cargar todos los datos
    eTrabajo nuevoTrabajo; //Aca vamos a cargar los datos
    eFecha fecha;
    int validFecha = 0;

    if(vec != NULL && tam > 0 && pId != NULL && notebooks != NULL && tamNot > 0 && servicios != NULL && tamSer > 0)
    {
        if(buscarTrabajoLibre(vec, tam, &indice)) //Buscamos un lugar donde podamos cargar datos (isEmpty == 1)
        {
            if(indice == -1) //Si no encontro lugar libre...
            {
                printf("No hay lugar en el sistema\n");
            }
            else
            {
                // Si encontro lugar libre ya empiezo a pedir y cargar datos:

 /*MODELO*/     listarNotebooks(notebooks, marcas, tamMar, tipos, tamTip);

 	 	 	 	printf("Ingrese la ID de la notebook: ");
                fflush(stdin);
				scanf("%d", &nuevoTrabajo.idNotebook);

				while(!validarNotebook(notebooks, tamNot, nuevoTrabajo.idNotebook))
				{
					printf("Error, esa ID no corresponde a ninguna Notebook. Reingrese ID: ");
					fflush(stdin);
					scanf("%d", &nuevoTrabajo.idNotebook);
				}


 /*MODELO*/     listarServicios(servicios, tamSer);

				printf("Ingrese la ID del servicio: ");
				fflush(stdin);
				scanf("%d", &nuevoTrabajo.idServicio);

				while(!validarServicio(servicios, tamSer, nuevoTrabajo.idServicio))
				{
					printf("Error, esa ID no corresponde a ningún servicio. Reingrese ID: ");
					fflush(stdin);
					scanf("%d", &nuevoTrabajo.idServicio);
				}

      	  	  	printf("Ingrese Fecha Pactada dd/mm/aaaa: ");
      	  	  	fflush(stdin);
                validFecha = scanf("%d/%d/%d", &fecha.dia, &fecha.mes, &fecha.anio);
                while(validFecha != 3 || validarFecha(&fecha) != 1)
                {
                	printf("Fecha inválida. Recuerde que debe separar día, mes y año (máx 2030) usando / / / \n");
					printf("Reingrese fecha dd/mm/aaaa: ");
					fflush(stdin);
					validFecha = scanf("%d/%d/%d", &fecha.dia, &fecha.mes, &fecha.anio);
                }

                nuevoTrabajo.fPactada = fecha;

                nuevoTrabajo.isEmpty = 0; //Pongo el isEmpty en 0 (ya no esta libre)
                nuevoTrabajo.id = *pId; //El legajo va a ser el que recibimos del main
                *pId = *pId + 1; //Ahora el legajo que recibimos del main, aumenta +1, para cargarselo al proximo
                vec[indice] = nuevoTrabajo; //Finalmente le pasamos todos los datos que cargamos, a la estructura real
                todoOk = 1;
            }
        }
        else
        {
            printf("Ocurrio un problema con los parámetros\n");
        }
    }
    return todoOk;
}




