/*
 * Trabajo.c
 *
 *  Created on: 11 may. 2022
 *      Author: JUNMI
 */

#include <stdio.h>
#include <stdlib.h>
#include <string.h>

#include "Trabajo.h"
#include "Servicio.h"
#include "Notebook.h"
#include "Marca.h"
#include "Tipo.h"
#include "Menu.h"
#include "Validaciones.h"


int mostrarTrabajo(eTrabajo lista, eNotebook notebooks[], int tamNot, eServicio servicios[], int tamSer)
{
    int todoOk = 0;
    char descServicio[20];

    if(notebooks != NULL && tamNot > 0 && servicios != NULL && tamSer > 0)
    {

    //cargarDescripcionMarca(marcas, tamMar, lista.idMarca, descMarca);
    cargarDescripcionServicio(servicios, tamSer, lista.idServicio, descServicio);
    //Le pasamos lista.idSector para que la función sepa cuál ID de sector tiene que buscar, si es correcta y la encuentra,
    //nos devuelve un char de descripción en el parámetro 'descSector'


    printf("  %4d  %5d  %10s  %10s     %02d/%02d/%d\n",
    		lista.id, lista.idNotebook, lista.idServicio, lista.fPactada);

        todoOk = 1;
    }
    return todoOk;
}

int listarTrabajos(eTrabajo vec[], eNotebook notebooks[], int tamNot, eServicio servicios[], int tamSer)
{
    int todoOk = 0;
    int flag = 0;
    if(vec != NULL && notebooks != NULL && tamNot > 0 && servicios != NULL && tamSer > 0)
    {
        printf("          *** Listado de Trabajos ***\n\n");
        printf("   ID             Notebook       Servicio       Fecha Pactada    \n");
        printf("-----------------------------------------------------------------\n");
        for(int i=0; i < 10; i++) // Recorro
        {
        	if(!vec[i].isEmpty)
        	{
                mostrarTrabajo(vec[i], notebooks, tamNot, servicios, tamSer);
                flag++;
        	}
        }
        if(flag == 0) //Si no hay mínimo 1 empleado... printeo que no hay
        {
            printf("     No hay trabajos en el sistema");
        }
        printf("\n\n");

        todoOk = 1;
    }
    return todoOk;
}

int buscarTrabajoLibre(eTrabajo vec[], int tam, int* pIndex)
{
    int todoOk = 0;
    if(vec != NULL && tam > 0 && pIndex != NULL)
    {
        *pIndex = -1;  //Ya lo cargamos con -1 (que no encontramos ninguno)
        for(int i=0; i < tam; i++) //Recorremos
        {
            if(vec[i].isEmpty == 1) //Si el empleado esta libre...
            {
                *pIndex = i; //Cargo el pIndex con el indice que acabamos de encontrar libre
                break; //Paramos de buscar
            }
        }
        todoOk = 1;
    }
    return todoOk;
}



int altaTrabajo(eTrabajo vec[], int tam, int* pId, eNotebook notebooks[], int tamNot, eServicio servicios[], int tamSer)
{                      //Recibe las estructuras con sus tam y un puntero a Legajo (ID)
    int todoOk = 0;
    int indice;   // Este va a ser indice al que le vamos a cargar todos los datos
    eTrabajo nuevoTrabajo; //Aca vamos a cargar los datos
    eFecha fecha;
    int validFecha;

    if(vec != NULL && tam > 0 && pId != NULL && notebooks != NULL && tamNot > 0 && servicios != NULL && tamSer > 0)
    {
        if(buscarTrabajoLibre(vec, tam, &indice)) //Buscamos un lugar donde podamos cargar datos (isEmpty == 1)
        {
            if(indice == -1) //Si no encontro lugar libre...
            {
                printf("No hay lugar en el sistema\n");
            }
            else
            {
                // Si encontro lugar libre ya empiezo a pedir y cargar datos:

            	listarMarcas(marcas, tamMar); //Primero muestro los sectores

				printf("Ingrese la ID de la marca a la que pertenece: ");
				scanf("%d", &nuevaNotebook.idMarca);

				while(!validarMarca(marcas, tamMar, nuevaNotebook.idMarca))
				{
					printf("Error, esa ID no corresponde a ninguna marca. Reingrese ID: ");
					fflush(stdin);
					scanf("%d", &nuevaNotebook.idMarca);
				}



 /*MODELO*/     listarNotebooks(notebooks, marcas, tamMar, tipos, tamTip);

 	 	 	 	printf("Ingrese la ID de la notebook: ");
                fflush(stdin);
				scanf("%d", &nuevoTrabajo.idMarca);

				while(!validarMarca(marcas, tamMar, nuevoTrabajo.idMarca))
				{
					printf("Error, esa ID no corresponde a ninguna marca. Reingrese ID: ");
					fflush(stdin);
					scanf("%d", &nuevoTrabajo.idMarca);
				}


/*MARCA*/       listarMarcas(marcas, tamMar); //Primero muestro los sectores

			    printf("Ingrese la ID de la marca a la que pertenece: ");
				scanf("%d", &nuevaNotebook.idMarca);

				while(!validarMarca(marcas, tamMar, nuevaNotebook.idMarca))
				{
					printf("Error, esa ID no corresponde a ninguna marca. Reingrese ID: ");
					fflush(stdin);
					scanf("%d", &nuevaNotebook.idMarca);
				}

/*TIPOS*/       listarTipos(tipos, tamTip); //Primero muestro los sectores

				printf("Ingrese la ID del tipo al que pertenece: ");
				scanf("%d", &nuevaNotebook.idTipo);

				while(!validarTipo(tipos, tamTip, nuevaNotebook.idTipo))
				{
					printf("Error, esa ID no corresponde a ningún tipo. Reingrese ID: ");
					fflush(stdin);
					scanf("%d", &nuevaNotebook.idTipo);
				}


/*PRECIO*/      printf("Ingrese precio: ");
				validPrecio = scanf("%f", &nuevaNotebook.precio);
                validarFloat(validPrecio, &nuevaNotebook.precio);


                nuevaNotebook.isEmpty = 0; //Pongo el isEmpty en 0 (ya no esta libre)
                nuevaNotebook.id = *pId; //El legajo va a ser el que recibimos del main
                *pId = *pId + 1; //Ahora el legajo que recibimos del main, aumenta +1, para cargarselo al proximo
                vec[indice] = nuevaNotebook; //Finalmente le pasamos todos los datos que cargamos, a la estructura real
                todoOk = 1;
            }
        }
        else
        {
            printf("Ocurrio un problema con los parámetros\n");
        }
    }
    return todoOk;
}




